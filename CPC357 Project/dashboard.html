<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Vertical Farm</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">

    <style>
       
        body { 
            font-family: 'Nunito', sans-serif; 
            text-align: center; 
            background-color: #f1f8e9; 
            color: #33691e; 
            margin: 0; 
            padding: 20px; 
        }

        h1 { color: #2e7d32; margin-bottom: 5px; }

        .status-pill {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            font-weight: bold;
        }

        .container { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 20px; 
            margin-top: 30px;
        }

        .card { 
            background: white; 
            padding: 20px; 
            width: 160px; 
            border-radius: 20px; 
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.1); 
            transition: transform 0.3s ease;
            border-bottom: 5px solid #a5d6a7; 
        }

        .card:hover { transform: translateY(-5px); }

        .card h3 {
            margin: 0;
            font-size: 1rem;
            color: #558b2f;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .icon { font-size: 2rem; margin: 10px 0; display: block; }

        .val { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: #1b5e20;
            display: block; 
        }

        .control-card {
            width: 300px;
            border-bottom: 5px solid #2e7d32; 
        }

        .control-input {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #c8e6c9;
            width: 60px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            text-align: center;
        }

        .btn-set {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-set:hover { background-color: #1b5e20; }

        .chart-container { 
            width: 90%; 
            max-width: 800px; 
            margin: 40px auto; 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }

        .sunny { background-color: #fffde7 !important; border-bottom-color: #fdd835 !important; }
        .rainy { background-color: #e3f2fd !important; border-bottom-color: #64b5f6 !important; }

        .dry-warning { 
            background-color: #fff3e0 !important; 
            border-bottom: 5px solid #ff9800 !important; 
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <h1><i class="fa-solid fa-seedling"></i> Smart Farm</h1>
    <div class="status-pill">
        System Status: <span id="status" style="color: orange;">Connecting...</span>
    </div>

    <div class="container">
        <div class="card" id="weather_card">
            <h3>Weather</h3>
            <span id="weather_icon" class="icon"><i class="fa-solid fa-sun" style="color: #FFD43B;"></i></span>
            <span id="weather_display" class="val">--</span>
        </div>

        <div class="card">
            <h3>Temp</h3>
            <span class="icon"><i class="fa-solid fa-temperature-full" style="color: #dc3838;"></i></span>
            <span id="temp_display" class="val">-- ¬∞C</span>
        </div>

        <div class="card" id="soil_card">
            <h3>Moisture</h3>
            <span class="icon"><i class="fa-solid fa-droplet" style="color: #74C0FC;"></i></span>
            <span id="soil_display" class="val">-- %</span>
        </div>

        <div class="card">
            <h3>Roof</h3>
            <span id="roof_icon" class="icon"><i class="fa-solid fa-people-roof" style="color: #63E6BE;"></i></span>
            <span id="roof_display" class="val">--</span>
        </div>

        <div class="card">
            <h3>Fan</h3>
            <span id="fan_icon" class="icon"><i class="fa-solid fa-fan fa-rotate-180" style="color: #74C0FC;"></i></span>
            <span id="fan_display" class="val">--</span>
        </div>

        <div class="card control-card">
            <h3>Fan Threshold</h3>
            <p style="margin: 5px 0; font-size: 0.9rem;">Turn fan on if temp ></p>
            <div style="display: flex; justify-content: center; gap: 10px; align-items: center;">
                <input type="number" id="tempInput" class="control-input" value="31">
                <button class="btn-set" onclick="setThreshold()">SET</button>
            </div>
            <p style="font-size: 0.8rem; color: #558b2f; margin-top: 10px;">
                Current Limit: <span id="current_limit" style="font-weight: bold;">--</span> ¬∞C
            </p>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="tempChart"></canvas>
    </div>

    <script>

        const VM_IP = "136.114.57.138"; 
        const MQTT_PORT = 9001; 
        const TOPIC_SENSORS = "farm/sensors";
        const TOPIC_CONTROL = "farm/control/temp"; 

        const client = new Paho.MQTT.Client(VM_IP, MQTT_PORT, "GreenDash_" + parseInt(Math.random() * 100));

        const ctx = document.getElementById('tempChart').getContext('2d');
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{ 
                    label: 'Temperature History (¬∞C)', 
                    data: [], 
                    borderColor: '#66bb6a', 
                    backgroundColor: 'rgba(102, 187, 106, 0.2)', 
                    borderWidth: 3,
                    pointBackgroundColor: '#2e7d32',
                    fill: true,
                    tension: 0.4 
                }] 
            },
            options: { 
                responsive: true, 
                plugins: { legend: { labels: { font: { family: 'Nunito' } } } },
                scales: { 
                    x: { 
                        grid: { display: false },
                        ticks: { display: false } 
                    },
                    y: { beginAtZero: false, grid: { borderDash: [5, 5] } } 
                } 
            }
        });


        function setThreshold() {
            const val = document.getElementById("tempInput").value;
            if(val) {
                console.log("Sending new limit: " + val);
                message = new Paho.MQTT.Message(val);
                message.destinationName = TOPIC_CONTROL;
                client.send(message);
                alert("New temperature limit sent: " + val + "¬∞C");
            }
        }


        client.onConnectionLost = (responseObject) => {
            console.log("Connection Lost: " + responseObject.errorMessage);
            const statusElem = document.getElementById("status");
            statusElem.innerText = "Disconnected";
            statusElem.style.color = "#e53935";
        };

        client.onMessageArrived = (msg) => {
            console.log("New Data:", msg.payloadString);
            const data = JSON.parse(msg.payloadString);
            
            document.getElementById("temp_display").innerText = data.temp + " ¬∞C";
            document.getElementById("weather_display").innerText = data.weather;
            document.getElementById("roof_display").innerText = data.roof;
            document.getElementById("fan_display").innerText = data.fan;
            document.getElementById("soil_display").innerText = data.soil + " %";


            if(data.limit) {
                document.getElementById("current_limit").innerText = data.limit;
            }

            const wCard = document.getElementById("weather_card");
            const sCard = document.getElementById("soil_card");
            const wIcon = document.getElementById("weather_icon");
            const rIcon = document.getElementById("roof_icon");
            const fIcon = document.getElementById("fan_icon");

            if (data.weather === "Raining") {
                wCard.className = "card rainy"; wIcon.innerText = "üåßÔ∏è";
            } else {
                wCard.className = "card sunny"; wIcon.innerText = "‚òÄÔ∏è";
            }

            if (data.soil < 30) {
                sCard.className = "card dry-warning"; 
                document.getElementById("soil_display").style.color = "#e65100";
            } else {
                sCard.className = "card";
                document.getElementById("soil_display").style.color = "#1b5e20";
            }

            if (data.roof.includes("Open")) rIcon.innerText = "üëê"; else rIcon.innerText = "üîí";
            if (data.fan === "ON") fIcon.innerText = "üå™Ô∏è"; else fIcon.innerText = "üõë";

            const timeLabel = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if(tempChart.data.labels.length > 15) {
                tempChart.data.labels.shift();
                tempChart.data.datasets[0].data.shift();
            }
            tempChart.data.labels.push(timeLabel);
            tempChart.data.datasets[0].data.push(data.temp);
            tempChart.update();
        };

        client.connect({ 
            onSuccess: () => { 
                console.log("Connected!");
                client.subscribe(TOPIC_SENSORS); 
                const statusElem = document.getElementById("status");
                statusElem.innerText = "Live & Connected";
                statusElem.style.color = "#2e7d32";
            }
        });
    </script>
</body>
</html>